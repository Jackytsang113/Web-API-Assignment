<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/nav.css" />
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/footer.css">
    <title>FoodShop</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
          <a class="navbar-brand" href="/">FoodShop</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="shop">Shop</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="order">Order</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="favorite">Favorite</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="userName" href="profile"><%=userName%></a>
              </li>
            </ul>
            <form class="d-flex">
              <button type="button" class="btn btn-warning" id="login_btn">Login</button>
              <button type="button" class="btn btn-danger" id="logout_btn" onclick="logout()">Logout</button>
            </form>
          </div>
        </div>
      </nav>
      <%userList.forEach(user => {%>
      <div class="container">
        <div class="row gutters">
        <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12">
        <div class="card h-100">
          <div class="card-body">
            <div class="account-settings">
              <div class="user-profile">
                <div class="user-avatar">
                  <img src="img/avatar.png" alt="Maxwell Admin">
                </div>
                <h5 class="user-name"><%=user.username%></h5>
                <h6 class="user-email"><%=user.email%></h6>
                <input type="hidden" id="userId" value="<%=user._id%>">
              </div>
              <div class="about">
                <h5>About</h5>
                <p>I'm <%=user.username%>. I love Food</p>
              </div>
            </div>
          </div>
        </div>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-12 col-sm-12 col-12">
        <div class="card h-100">
          <div class="card-body">
            <div class="row gutters">
              <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                <h6 class="mb-2 text-primary">Personal Details</h6>
              </div>
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                <div class="form-group">
                  <label for="fullname">Full Name</label>
                  <input type="text" class="form-control" id="fullname" placeholder="Enter full name" value="<%=user.fullname%>">
                </div>
              </div>
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" class="form-control" id="email" placeholder="Enter email ID" value="<%=user.email%>">
                </div>
              </div>
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                <div class="form-group">
                  <label for="phone">Phone</label>
                  <input type="text" class="form-control" id="phone" placeholder="Enter phone number" value="<%=user.phone%>">
                </div>
              </div>
            </div>
            <div class="row gutters">
              <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                <h6 class="mt-3 mb-2 text-primary">Address</h6>
              </div>
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                <div class="form-group">
                  <label for="Street">Street</label>
                  <input type="name" class="form-control" id="Street" placeholder="Enter Street" value="Hong Kong" readonly>
                </div>
              </div>
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                <div class="form-group">
                  <label for="ciTy">City</label>
                  <input type="name" class="form-control" id="ciTy" placeholder="Enter City" value="Hong Kong" readonly>
                </div>
              </div>
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                <div class="form-group">
                  <label for="sTate">State</label>
                  <input type="text" class="form-control" id="sTate" placeholder="Enter State" value="Hong Kong" readonly>
                </div>
              </div>
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                <div class="form-group">
                  <label for="zIp">Zip Code</label>
                  <input type="text" class="form-control" id="zIp" placeholder="Zip Code" value="000000" readonly>
                </div>
              </div>
            </div>
          </br>
            <div class="row gutters">
              <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                <div class="text-right">
                  <button type="button" id="submit" name="submit" class="btn btn-secondary" onclick="reset()">Cancel</button>
                  <button type="button" id="submit" name="submit" class="btn btn-primary" onclick="editprofile()">Update</button>
                  <button type="button" id="submit" name="submit" class="btn btn-success changepwd" href="#resetPwdModal" data-toggle="modal"  onclick="">Change Password</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
        </div>
        </div>
        <%})%>

        <footer>
          <div class="footer-current">
            <div id="tripleARow">
              <ul>
                <h2>About</h2>
                <li><a href="">FoodShop</a></li>
                <li><a href="">Media Reports</a></li>
                <li><a href="">Technical Log</a></li>
                <li><a href="">Design Blog</a></li>
                <li><a href="">Career Opportunities</a></li>
                <li><a href="">Restaurant Registration</a></li>
              </ul>
            </div>
            <div id="tripleARow">
              <ul>
                <h2>Legal</h2>
                <li><a href="">Terms of Use</a></li>
                <li><a href="">Privacy Policy and Terms</a></li>
                <li><a href="">Cookie Information</a></li>
              </ul>
            </div>
            <div id="tripleARow">
              <ul>
                <h2>Help</h2>
                <li><a href="">Contact Method</a></li>
                <li><a href="">Common Problem</a></li>
                <li><a href="">Dishes</a></li>
                <li><a href="">Sitemap</a></li>
              </ul>
            </div>
          </div>
          <div class="footer-statement">
            <p>Copyright &copy;
              <script>document.write(new Date().getFullYear());</script>,TSANG Ho Yin</p>
          </div>
        </footer>

  <!-- Reset Modal HTML -->
  <div id="resetPwdModal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>New Password</label>
            <input type="password" class="form-control" id="newPwd">
          </div>
          <div class="form-group">
            <label>New Re-Enter Password</label>
            <input type="password" class="form-control" id="reNewPwd">
          </div>
          <div id="loadPos"></div>
        </div>
        <div class="modal-footer">
          <input type="button" class="btn btn-default" value="Cancel" onclick="reset()">
          <input type="submit" class="btn btn-primary" value="Confirm" onclick="change_pwd()">
        </div>
      </div>
    </div>
  </div>
  <!-- Reset Modal HTML -->

    <!-- jquery -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <!-- bootstrap js -->
    <script src="js/bootstrap.bundle.min.js"></script>
    <!-- script js -->

    <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
    <input type="hidden" id="islogin" value="<%= islogin %>">
    <script>
        console.log(document.getElementById('islogin').value);
        if(document.getElementById('islogin').value == "true"){
          document.getElementById('login_btn').style.display = 'none';
          document.getElementById('logout_btn').style.display = 'block';
        }else{
          document.getElementById('login_btn').style.display = 'block';
          document.getElementById('logout_btn').style.display = 'none';
        }

        function reset(){
          location.reload();
        }

        async function editprofile(){
          event.preventDefault();

          const id = document.getElementById('userId').value;
          const fullname = document.getElementById('fullname').value;
          const email = document.getElementById('email').value;
          const phone = document.getElementById('phone').value;

          
          const result = await fetch('/api/editprofile',{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id,
                    fullname,
                    email,
                    phone
                })
            }).then((res) => res.json())

            if(result.status === 'ok'){
                alert('Success edit profile')
                location.reload();
            }else{
                alert(result.error)
            }
        }

        async function change_pwd(){
          event.preventDefault();
          const password =  document.getElementById('newPwd').value;
          const reNewPwd = document.getElementById('reNewPwd').value;

          if(password === reNewPwd){
            const result = await fetch('/api/change-password',{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    newpassword: password,
                    token: localStorage.getItem('token')
                })
            }).then((res) => res.json())

            if(result.status === 'ok'){
                location.reload();
                alert('Success change password')
            }else{
              alert(result.error)
            }
          }else{
            document.getElementById("newPwd").value = "";
            document.getElementById("reNewPwd").value = "";
            alert('Password and Retype password should be the same!')
          }
        }

        async function logout(){
            event.preventDefault();
            const result = await fetch('/api/logout',{
                method: 'GET'
            }).then((res) => res.json())

            if(result.status === 'ok'){
                location = "login"
                alert('Success logout')
            }else{
                alert(result.error)
            }
        }
    </script>
</body>
</html>